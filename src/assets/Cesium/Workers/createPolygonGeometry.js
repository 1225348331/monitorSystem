define(["./when-4bbc8319","./Matrix2-fa56e6dd","./ArcType-98ec98bf","./GeometryOffsetAttribute-58373def","./BoundingRectangle-f17163d6","./Transforms-d150322f","./Check-ba987d16","./ComponentDatatype-bfa70d4a","./EllipsoidGeodesic-89883ae6","./EllipsoidTangentPlane-fb029ce5","./GeometryAttribute-e8a7fd74","./GeometryInstance-e3e7bf6e","./GeometryPipeline-91e25716","./IndexDatatype-81fb2229","./PolygonGeometryLibrary-da743763","./PolygonPipeline-65365f79","./VertexFormat-33d5a7e0","./RuntimeError-55ee6bc3","./combine-83860057","./WebGLConstants-1c8239cc","./AxisAlignedBoundingBox-9aec5e41","./IntersectionTests-d4f2fcd6","./Plane-034a4517","./AttributeCompression-943b6739","./EncodedCartesian3-77992927","./arrayRemoveDuplicates-48046ac4","./EllipsoidRhumbLine-7ae2cb99","./GeometryAttributes-7827a6c2"],function(z,W,c,Y,e,U,n,j,p,G,Q,O,V,D,F,L,v,t,o,r,a,i,s,l,u,y,m,g){"use strict";var q=new W.Cartographic,K=new W.Cartographic,d=new W.Cartographic;var N=new e.BoundingRectangle,Z=new W.Cartesian3,J=new W.Cartesian3,X=new W.Cartesian3,$=new W.Cartesian3,ee=new W.Cartesian3,te=new W.Cartesian3,oe=new W.Cartesian3,re=new W.Cartesian3,ae=new W.Cartesian3,ie=new W.Cartesian2,ne=new W.Cartesian2,se=new W.Cartesian3,le=new U.Quaternion,ue=new W.Matrix3,ye=new W.Matrix3;function H(e){var t,o=e.vertexFormat,r=e.geometry,a=e.shadowVolume,i=r.attributes.position.values,n=i.length,s=e.wall,l=e.top||s,u=e.bottom||s;if(o.st||o.normal||o.tangent||o.bitangent||a){var y=e.boundingRectangle,c=e.tangentPlane,p=e.ellipsoid,m=e.stRotation,g=e.perPositionHeight,d=ie;d.x=y.x,d.y=y.y;var h,f=o.st?new Float32Array(n/3*2):void 0;o.normal&&(h=g&&l&&!s?r.attributes.normal.values:new Float32Array(n));var _,v=o.tangent?new Float32Array(n):void 0,P=o.bitangent?new Float32Array(n):void 0,b=a?new Float32Array(n):void 0,C=0,w=0,x=J,T=X,I=$,A=!0,E=ue,G=ye;G=0!==m?(_=U.Quaternion.fromAxisAngle(c._plane.normal,m,le),E=W.Matrix3.fromQuaternion(_,E),_=U.Quaternion.fromAxisAngle(c._plane.normal,-m,le),W.Matrix3.fromQuaternion(_,G)):(E=W.Matrix3.clone(W.Matrix3.IDENTITY,E),W.Matrix3.clone(W.Matrix3.IDENTITY,G));var O=0,V=0;l&&u&&(O=n/2,V=n/3,n/=2);for(var D=0;D<n;D+=3){var F,L,N,H,R,M,S,B,k=W.Cartesian3.fromArray(i,D,se);o.st&&(F=W.Matrix3.multiplyByVector(E,k,Z),F=p.scaleToGeodeticSurface(F,F),L=c.projectPointOntoPlane(F,ne),W.Cartesian2.subtract(L,d,L),N=j.CesiumMath.clamp(L.x/y.width,0,1),H=j.CesiumMath.clamp(L.y/y.height,0,1),u&&(f[C+V]=N,f[C+1+V]=H),l&&(f[C]=N,f[C+1]=H),C+=2),(o.normal||o.tangent||o.bitangent||a)&&(R=w+1,M=w+2,s?(D+3<n&&(S=W.Cartesian3.fromArray(i,D+3,ee),A&&(B=W.Cartesian3.fromArray(i,D+n,te),g&&(t=k,F=S,L=B,N=void 0,N=(H=p).cartesianToCartographic(t,q).height,(t=H.cartesianToCartographic(F,K)).height=N,H.cartographicToCartesian(t,F),(F=H.cartesianToCartographic(L,K)).height=N-100,H.cartographicToCartesian(F,L)),W.Cartesian3.subtract(S,k,S),W.Cartesian3.subtract(B,k,B),x=W.Cartesian3.normalize(W.Cartesian3.cross(B,S,x),x),A=!1),W.Cartesian3.equalsEpsilon(S,k,j.CesiumMath.EPSILON10)&&(A=!0)),(o.tangent||o.bitangent)&&(I=p.geodeticSurfaceNormal(k,I),o.tangent&&(T=W.Cartesian3.normalize(W.Cartesian3.cross(I,x,T),T)))):(x=p.geodeticSurfaceNormal(k,x),(o.tangent||o.bitangent)&&(g&&(oe=W.Cartesian3.fromArray(h,w,oe),re=W.Cartesian3.cross(W.Cartesian3.UNIT_Z,oe,re),re=W.Cartesian3.normalize(W.Matrix3.multiplyByVector(G,re,re),re),o.bitangent&&(ae=W.Cartesian3.normalize(W.Cartesian3.cross(oe,re,ae),ae))),T=W.Cartesian3.cross(W.Cartesian3.UNIT_Z,x,T),T=W.Cartesian3.normalize(W.Matrix3.multiplyByVector(G,T,T),T),o.bitangent&&(I=W.Cartesian3.normalize(W.Cartesian3.cross(x,T,I),I)))),o.normal&&(e.wall?(h[w+O]=x.x,h[R+O]=x.y,h[M+O]=x.z):u&&(h[w+O]=-x.x,h[R+O]=-x.y,h[M+O]=-x.z),(l&&!g||s)&&(h[w]=x.x,h[R]=x.y,h[M]=x.z)),a&&(s&&(x=p.geodeticSurfaceNormal(k,x)),b[w+O]=-x.x,b[R+O]=-x.y,b[M+O]=-x.z),o.tangent&&(e.wall?(v[w+O]=T.x,v[R+O]=T.y,v[M+O]=T.z):u&&(v[w+O]=-T.x,v[R+O]=-T.y,v[M+O]=-T.z),l&&(g?(v[w]=re.x,v[R]=re.y,v[M]=re.z):(v[w]=T.x,v[R]=T.y,v[M]=T.z))),o.bitangent&&(u&&(P[w+O]=I.x,P[R+O]=I.y,P[M+O]=I.z),l&&(g?(P[w]=ae.x,P[R]=ae.y,P[M]=ae.z):(P[w]=I.x,P[R]=I.y,P[M]=I.z))),w+=3)}o.st&&(r.attributes.st=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:f})),o.normal&&(r.attributes.normal=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:h})),o.tangent&&(r.attributes.tangent=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:v})),o.bitangent&&(r.attributes.bitangent=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:P})),a&&(r.attributes.extrudeDirection=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:b}))}return e.extrude&&z.defined(e.offsetAttribute)&&(m=i.length/3,_=new Uint8Array(m),e.offsetAttribute===Y.GeometryOffsetAttribute.TOP?l&&u||s?_=Y.arrayFill(_,1,0,m/2):l&&(_=Y.arrayFill(_,1)):(m=e.offsetAttribute===Y.GeometryOffsetAttribute.NONE?0:1,_=Y.arrayFill(_,m)),r.attributes.applyOffset=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:_})),r}var h=new W.Cartographic,f=new W.Cartographic,_={westOverIDL:0,eastOverIDL:0},P=new p.EllipsoidGeodesic;function b(e,t,o,r,a){if(a=z.defaultValue(a,new W.Rectangle),!z.defined(e)||e.length<3)return a.west=0,a.north=0,a.south=0,a.east=0,a;if(o===c.ArcType.RHUMB)return W.Rectangle.fromCartesianArray(e,t,a);P.ellipsoid.equals(t)||(P=new p.EllipsoidGeodesic(void 0,void 0,t)),a.west=Number.POSITIVE_INFINITY,a.east=Number.NEGATIVE_INFINITY,a.south=Number.POSITIVE_INFINITY,a.north=Number.NEGATIVE_INFINITY,_.westOverIDL=Number.POSITIVE_INFINITY,_.eastOverIDL=Number.NEGATIVE_INFINITY;for(var i,n=1/j.CesiumMath.chordLength(r,t.maximumRadius),s=e.length,l=t.cartesianToCartographic(e[0],f),u=h,y=1;y<s;y++)i=u,u=l,l=t.cartesianToCartographic(e[y],i),P.setEndPoints(u,l),w(P,n,a,_);return i=u,u=l,l=t.cartesianToCartographic(e[0],i),P.setEndPoints(u,l),w(P,n,a,_),a.east-a.west>_.eastOverIDL-_.westOverIDL&&(a.west=_.westOverIDL,a.east=_.eastOverIDL,a.east>j.CesiumMath.PI&&(a.east=a.east-j.CesiumMath.TWO_PI),a.west>j.CesiumMath.PI&&(a.west=a.west-j.CesiumMath.TWO_PI)),a}var C=new W.Cartographic;function w(e,t,o,r){for(var a=e.surfaceDistance,i=Math.ceil(a*t),n=0<i?a/(i-1):Number.POSITIVE_INFINITY,s=0,l=0;l<i;l++){var u=e.interpolateUsingSurfaceDistance(s,C);s+=n;var y=u.longitude,u=u.latitude;o.west=Math.min(o.west,y),o.east=Math.max(o.east,y),o.south=Math.min(o.south,u),o.north=Math.max(o.north,u);y=0<=y?y:y+j.CesiumMath.TWO_PI;r.westOverIDL=Math.min(r.westOverIDL,y),r.eastOverIDL=Math.max(r.eastOverIDL,y)}}var R=[];function x(e){var t,o=e.polygonHierarchy,r=z.defaultValue(e.vertexFormat,v.VertexFormat.DEFAULT),a=z.defaultValue(e.ellipsoid,W.Ellipsoid.WGS84),i=z.defaultValue(e.granularity,j.CesiumMath.RADIANS_PER_DEGREE),n=z.defaultValue(e.stRotation,0),s=z.defaultValue(e.perPositionHeight,!1),l=s&&z.defined(e.extrudedHeight),u=z.defaultValue(e.height,0),y=z.defaultValue(e.extrudedHeight,u);l||(t=Math.max(u,y),y=Math.min(u,y),u=t),this._vertexFormat=v.VertexFormat.clone(r),this._ellipsoid=W.Ellipsoid.clone(a),this._granularity=i,this._stRotation=n,this._height=u,this._extrudedHeight=y,this._closeTop=z.defaultValue(e.closeTop,!0),this._closeBottom=z.defaultValue(e.closeBottom,!0),this._polygonHierarchy=o,this._perPositionHeight=s,this._perPositionHeightExtrude=l,this._shadowVolume=z.defaultValue(e.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=e.offsetAttribute,this._arcType=z.defaultValue(e.arcType,c.ArcType.GEODESIC),this._multiPoly=z.defaultValue(e.multiPoly,0),this._revertPolygon=z.defaultValue(e.revertPolygon,0),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=F.PolygonGeometryLibrary.computeHierarchyPackedLength(o)+W.Ellipsoid.packedLength+v.VertexFormat.packedLength+15}x.fromPositions=function(e){return new x({polygonHierarchy:{positions:(e=z.defaultValue(e,z.defaultValue.EMPTY_OBJECT)).positions},height:e.height,extrudedHeight:e.extrudedHeight,vertexFormat:e.vertexFormat,stRotation:e.stRotation,ellipsoid:e.ellipsoid,granularity:e.granularity,perPositionHeight:e.perPositionHeight,closeTop:e.closeTop,closeBottom:e.closeBottom,offsetAttribute:e.offsetAttribute,arcType:e.arcType,multiPoly:e.multiPoly,revertPolygon:e.revertPolygon})},x.pack=function(e,t,o){return o=z.defaultValue(o,0),o=F.PolygonGeometryLibrary.packPolygonHierarchy(e._polygonHierarchy,t,o),W.Ellipsoid.pack(e._ellipsoid,t,o),o+=W.Ellipsoid.packedLength,v.VertexFormat.pack(e._vertexFormat,t,o),o+=v.VertexFormat.packedLength,t[o++]=e._height,t[o++]=e._extrudedHeight,t[o++]=e._granularity,t[o++]=e._stRotation,t[o++]=e._perPositionHeightExtrude?1:0,t[o++]=e._perPositionHeight?1:0,t[o++]=e._closeTop?1:0,t[o++]=e._closeBottom?1:0,t[o++]=e._shadowVolume?1:0,t[o++]=z.defaultValue(e._offsetAttribute,-1),t[o++]=e._arcType,t[o++]=e._multiPoly,t[o++]=e._revertPolygon?1:0,t[o]=e.packedLength,t};var T=W.Ellipsoid.clone(W.Ellipsoid.UNIT_SPHERE),I=new v.VertexFormat,A={polygonHierarchy:{}};function M(e,t){n.Check.defined("cartesians",e),z.defined(t)||(t=[]);for(var o=0,r=e.length,a=0;a<r;a++){var i=e[a],i=W.Cartographic.fromCartesian(i,void 0,d);z.defined(i)&&(t[o]=new W.Cartesian2(j.CesiumMath.toDegrees(i.longitude),j.CesiumMath.toDegrees(i.latitude)),o++)}return t.length=o,t}return x.unpack=function(e,t,o){t=z.defaultValue(t,0);var r=F.PolygonGeometryLibrary.unpackPolygonHierarchy(e,t);t=r.startingIndex,delete r.startingIndex;var a=W.Ellipsoid.unpack(e,t,T);t+=W.Ellipsoid.packedLength;var i=v.VertexFormat.unpack(e,t,I);t+=v.VertexFormat.packedLength;var n=e[t++],s=e[t++],l=e[t++],u=e[t++],y=1===e[t++],c=1===e[t++],p=1===e[t++],m=1===e[t++],g=1===e[t++],d=e[t++],h=e[t++],f=e[t++],_=e[t++],t=e[t];return(o=!z.defined(o)?new x(A):o)._polygonHierarchy=r,o._ellipsoid=W.Ellipsoid.clone(a,o._ellipsoid),o._vertexFormat=v.VertexFormat.clone(i,o._vertexFormat),o._height=n,o._extrudedHeight=s,o._granularity=l,o._stRotation=u,o._perPositionHeightExtrude=y,o._perPositionHeight=c,o._closeTop=p,o._closeBottom=m,o._shadowVolume=g,o._offsetAttribute=-1===d?void 0:d,o._arcType=h,o._multiPoly=f,o._revertPolygon=_,o.packedLength=t,o},x.computeRectangle=function(e,t){var o=z.defaultValue(e.granularity,j.CesiumMath.RADIANS_PER_DEGREE),r=z.defaultValue(e.arcType,c.ArcType.GEODESIC),a=e.polygonHierarchy,e=z.defaultValue(e.ellipsoid,W.Ellipsoid.WGS84);return b(a.positions,e,r,o,t)},x.createGeometry=function(e){var t=e._vertexFormat,o=e._ellipsoid,r=e._granularity,a=e._stRotation,i=e._polygonHierarchy,n=e._perPositionHeight,s=e._closeTop,l=e._closeBottom,u=e._arcType,y=e._multiPoly;if(!((h=i.positions).length<3)){var c=G.EllipsoidTangentPlane.fromPoints(h,o),y=y&&(1===y||2===y&&z.defined(i.holes)&&9<i.holes.length)?(p=M,1):(p=c.projectPointsOntoPlane.bind(c),0),p=F.PolygonGeometryLibrary.polygonsFromHierarchy(i,p,!n,o),m=p.hierarchy,g=p.polygons;if(0!==m.length){var d,h=m[0].outerRing,h=F.PolygonGeometryLibrary.computeBoundingRectangle(c.plane.normal,c.projectPointOntoPlane.bind(c),h,a,N),f=[],_=e._height,v=e._extrudedHeight,P={perPositionHeight:n,vertexFormat:t,geometry:void 0,tangentPlane:c,boundingRectangle:h,ellipsoid:o,stRotation:a,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:u};if(e._perPositionHeightExtrude||!j.CesiumMath.equalsEpsilon(_,v,0,j.CesiumMath.EPSILON2))for(P.extrude=!0,P.top=s,P.bottom=l,P.shadowVolume=e._shadowVolume,P.offsetAttribute=e._offsetAttribute,d=0;d<g.length;d++){g[d]._revertPolygon=e._revertPolygon,g[d]._multiPoly=y;var b,C=function(e,t,o,r,a,i,n,s,l){var u={walls:[]};if(i||n){var y=F.PolygonGeometryLibrary.createGeometryFromPositions(e,t,o,a,s,l),t=y.attributes.position.values,c=y.indices;if(i&&n){var p,i=t.concat(t),m=i.length/3;(p=D.IndexDatatype.createTypedArray(m,2*c.length)).set(c);for(var g=c.length,d=m/2,h=0;h<g;h+=3){var f=p[h]+d,_=p[h+1]+d,v=p[h+2]+d;p[h+g]=v,p[h+1+g]=_,p[h+2+g]=f}y.attributes.position.values=i,a&&s.normal&&(s=y.attributes.normal.values,y.attributes.normal.values=new Float32Array(i.length),y.attributes.normal.values.set(s)),y.indices=p}else if(n){for(m=t.length/3,p=D.IndexDatatype.createTypedArray(m,c.length),h=0;h<c.length;h+=3)p[h]=c[h+2],p[h+1]=c[h+1],p[h+2]=c[h];y.indices=p}u.topAndBottom=new O.GeometryInstance({geometry:y})}var y=r.outerRing,P=G.EllipsoidTangentPlane.fromPoints(y,e).projectPointsOntoPlane(y,R);L.PolygonPipeline.computeWindingOrder2D(P)===L.WindingOrder.CLOCKWISE&&(y=y.slice().reverse());var b=F.PolygonGeometryLibrary.computeWallGeometry(y,e,o,a,l);u.walls.push(new O.GeometryInstance({geometry:b}));var C=r.holes;for(h=0;h<C.length;h++){var w=C[h],P=G.EllipsoidTangentPlane.fromPoints(w,e).projectPointsOntoPlane(w,R);L.PolygonPipeline.computeWindingOrder2D(P)===L.WindingOrder.COUNTER_CLOCKWISE&&(w=w.slice().reverse()),b=F.PolygonGeometryLibrary.computeWallGeometry(w,e,o,a,l),u.walls.push(new O.GeometryInstance({geometry:b}))}return u}(o,g[d],r,m[d],n,s,l,t,u);s&&l?(b=C.topAndBottom,P.geometry=F.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(b.geometry,_,v,o,n)):s?((b=C.topAndBottom).geometry.attributes.position.values=L.PolygonPipeline.scaleToGeodeticHeight(b.geometry.attributes.position.values,_,o,!n),P.geometry=b.geometry):l&&((b=C.topAndBottom).geometry.attributes.position.values=L.PolygonPipeline.scaleToGeodeticHeight(b.geometry.attributes.position.values,v,o,!0),P.geometry=b.geometry),(s||l)&&(P.wall=!1,b.geometry=H(P),f.push(b));var w=C.walls;P.wall=!0;for(var x=0;x<w.length;x++){var T=w[x];P.geometry=F.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(T.geometry,_,v,o,n),T.geometry=H(P),f.push(T)}}else for(d=0;d<g.length;d++){g[d]._revertPolygon=e._revertPolygon,g[d]._multiPoly=y;var I,A,E=new O.GeometryInstance({geometry:F.PolygonGeometryLibrary.createGeometryFromPositions(o,g[d],r,n,t,u)});E.geometry.attributes.position.values=L.PolygonPipeline.scaleToGeodeticHeight(E.geometry.attributes.position.values,_,o,!n),P.geometry=E.geometry,E.geometry=H(P),z.defined(e._offsetAttribute)&&(A=E.geometry.attributes.position.values.length,I=new Uint8Array(A/3),A=e._offsetAttribute===Y.GeometryOffsetAttribute.NONE?0:1,Y.arrayFill(I,A),E.geometry.attributes.applyOffset=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:I})),f.push(E)}c=V.GeometryPipeline.combineInstances(f)[0];c.attributes.position.values=new Float64Array(c.attributes.position.values),c.indices=D.IndexDatatype.createTypedArray(c.attributes.position.values.length/3,c.indices);h=c.attributes,a=U.BoundingSphere.fromVertices(h.position.values);return t.position||delete h.position,new Q.Geometry({attributes:h,indices:c.indices,primitiveType:c.primitiveType,boundingSphere:a,offsetAttribute:e._offsetAttribute})}}},x.createShadowVolume=function(e,t,o){var r=e._granularity,a=e._ellipsoid,t=t(r,a),o=o(r,a);return new x({polygonHierarchy:e._polygonHierarchy,ellipsoid:a,stRotation:e._stRotation,granularity:r,perPositionHeight:!1,extrudedHeight:t,height:o,vertexFormat:v.VertexFormat.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},Object.defineProperties(x.prototype,{rectangle:{get:function(){var e;return z.defined(this._rectangle)||(e=this._polygonHierarchy.positions,this._rectangle=b(e,this._ellipsoid,this._arcType,this._granularity)),this._rectangle}},textureCoordinateRotationPoints:{get:function(){return z.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(e){var t=-e._stRotation;if(0==t)return[0,0,0,1,1,0];var o=e._ellipsoid,r=e._polygonHierarchy.positions,e=e.rectangle;return Q.Geometry._textureCoordinateRotationPoints(r,t,o,e)}(this)),this._textureCoordinateRotationPoints}}}),function(e,t){return(e=z.defined(t)?x.unpack(e,t):e)._ellipsoid=W.Ellipsoid.clone(e._ellipsoid),x.createGeometry(e)}});
