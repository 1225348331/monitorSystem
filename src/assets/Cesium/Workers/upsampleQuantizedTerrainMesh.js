define(["./AttributeCompression-943b6739","./Transforms-d150322f","./Matrix2-fa56e6dd","./when-4bbc8319","./TerrainEncoding-8b8f8e9f","./IndexDatatype-81fb2229","./Check-ba987d16","./ComponentDatatype-bfa70d4a","./OrientedBoundingBox-3b5a3b97","./createTaskProcessorWorker","./combine-83860057","./RuntimeError-55ee6bc3","./WebGLConstants-1c8239cc","./EllipsoidTangentPlane-fb029ce5","./AxisAlignedBoundingBox-9aec5e41","./IntersectionTests-d4f2fcd6","./Plane-034a4517"],function(s,oe,ae,g,pe,de,e,fe,le,t,i,n,r,h,u,o,a){"use strict";var ce={clipTriangleAtAxisAlignedThreshold:function(e,t,i,n,s,r){var h,u;g.defined(r)?r.length=0:r=[];var o,a,p,d,f,l,c=t?(h=i<e,u=n<e,s<e):(h=e<i,u=e<n,e<s),t=h+u+c;return 1===t?h?(o=(e-i)/(n-i),a=(e-i)/(s-i),r.push(1),r.push(2),1!==a&&(r.push(-1),r.push(0),r.push(2),r.push(a)),1!==o&&(r.push(-1),r.push(0),r.push(1),r.push(o))):u?(p=(e-n)/(s-n),d=(e-n)/(i-n),r.push(2),r.push(0),1!==d&&(r.push(-1),r.push(1),r.push(0),r.push(d)),1!==p&&(r.push(-1),r.push(1),r.push(2),r.push(p))):c&&(f=(e-s)/(i-s),l=(e-s)/(n-s),r.push(0),r.push(1),1!==l&&(r.push(-1),r.push(2),r.push(1),r.push(l)),1!==f&&(r.push(-1),r.push(2),r.push(0),r.push(f))):2===t?h||i===e?u||n===e?c||s===e||(a=(e-i)/(s-i),p=(e-n)/(s-n),r.push(2),r.push(-1),r.push(0),r.push(2),r.push(a),r.push(-1),r.push(1),r.push(2),r.push(p)):(l=(e-s)/(n-s),o=(e-i)/(n-i),r.push(1),r.push(-1),r.push(2),r.push(1),r.push(l),r.push(-1),r.push(0),r.push(1),r.push(o)):(d=(e-n)/(i-n),f=(e-s)/(i-s),r.push(0),r.push(-1),r.push(1),r.push(0),r.push(d),r.push(-1),r.push(2),r.push(0),r.push(f)):3!==t&&(r.push(0),r.push(1),r.push(2)),r},computeBarycentricCoordinates:function(e,t,i,n,s,r,h,u,o){var a=i-h,i=h-s,s=r-u,r=n-u,n=1/(s*a+i*r),u=t-u,h=e-h,i=(s*h+i*u)*n,u=(-r*h+a*u)*n,n=1-i-u;return g.defined(o)?(o.x=i,o.y=u,o.z=n,o):new ae.Cartesian3(i,u,n)},computeLineSegmentLineSegmentIntersection:function(e,t,i,n,s,r,h,u,o){var a=(h-s)*(t-r)-(u-r)*(e-s),p=(i-e)*(t-r)-(n-t)*(e-s),s=(u-r)*(i-e)-(h-s)*(n-t);if(0!=s){a=a/s,s=p/s;return 0<=a&&a<=1&&0<=s&&s<=1?((o=!g.defined(o)?new ae.Cartesian2:o).x=e+a*(i-e),o.y=t+a*(n-t),o):void 0}}},ge=32767,me=16383,xe=[],ve=[],we=[],Ce=new ae.Cartographic,Be=new ae.Cartesian3,ye=[],be=[],Ie=[],Ae=[],Te=[],ze=new ae.Cartesian3,Me=new oe.BoundingSphere,Ne=new le.OrientedBoundingBox,Ve=new ae.Cartesian2,Ee=new ae.Cartesian3;function Re(){this.vertexBuffer=void 0,this.index=void 0,this.first=void 0,this.second=void 0,this.ratio=void 0}Re.prototype.clone=function(e){return(e=!g.defined(e)?new Re:e).uBuffer=this.uBuffer,e.vBuffer=this.vBuffer,e.heightBuffer=this.heightBuffer,e.normalBuffer=this.normalBuffer,e.index=this.index,e.first=this.first,e.second=this.second,e.ratio=this.ratio,e},Re.prototype.initializeIndexed=function(e,t,i,n,s){this.uBuffer=e,this.vBuffer=t,this.heightBuffer=i,this.normalBuffer=n,this.index=s,this.first=void 0,this.second=void 0,this.ratio=void 0},Re.prototype.initializeFromClipResult=function(e,t,i){var n=t+1;return-1!==e[t]?i[e[t]].clone(this):(this.vertexBuffer=void 0,this.index=void 0,this.first=i[e[n]],this.second=i[e[++n]],this.ratio=e[++n],++n),n},Re.prototype.getKey=function(){return this.isIndexed()?this.index:JSON.stringify({first:this.first.getKey(),second:this.second.getKey(),ratio:this.ratio})},Re.prototype.isIndexed=function(){return g.defined(this.index)},Re.prototype.getH=function(){return g.defined(this.index)?this.heightBuffer[this.index]:fe.CesiumMath.lerp(this.first.getH(),this.second.getH(),this.ratio)},Re.prototype.getU=function(){return g.defined(this.index)?this.uBuffer[this.index]:fe.CesiumMath.lerp(this.first.getU(),this.second.getU(),this.ratio)},Re.prototype.getV=function(){return g.defined(this.index)?this.vBuffer[this.index]:fe.CesiumMath.lerp(this.first.getV(),this.second.getV(),this.ratio)};var p=new ae.Cartesian2,d=-1,f=[new ae.Cartesian3,new ae.Cartesian3],l=[new ae.Cartesian3,new ae.Cartesian3];function c(e,t){var i=f[++d],n=l[d],i=s.AttributeCompression.octDecode(e.first.getNormalX(),e.first.getNormalY(),i),n=s.AttributeCompression.octDecode(e.second.getNormalX(),e.second.getNormalY(),n);return Be=ae.Cartesian3.lerp(i,n,e.ratio,Be),ae.Cartesian3.normalize(Be,Be),s.AttributeCompression.octEncode(Be,t),--d,t}Re.prototype.getNormalX=function(){return g.defined(this.index)?this.normalBuffer[2*this.index]:(p=c(this,p)).x},Re.prototype.getNormalY=function(){return g.defined(this.index)?this.normalBuffer[2*this.index+1]:(p=c(this,p)).y};var m=[];function He(e,t,i,n,s,r,h,u,o){if(0!==h.length){for(var a=0,p=0;p<h.length;)p=m[a++].initializeFromClipResult(h,p,u);for(var d=0;d<a;++d){var f,l,c=m[d];c.isIndexed()?(c.newIndex=r[c.index],c.uBuffer=e,c.vBuffer=t,c.heightBuffer=i,o&&(c.normalBuffer=n)):(f=c.getKey(),g.defined(r[f])?c.newIndex=r[f]:(l=e.length,e.push(c.getU()),t.push(c.getV()),i.push(c.getH()),o&&(n.push(c.getNormalX()),n.push(c.getNormalY())),c.newIndex=l,r[f]=l))}3===a?(s.push(m[0].newIndex),s.push(m[1].newIndex),s.push(m[2].newIndex)):4===a&&(s.push(m[0].newIndex),s.push(m[1].newIndex),s.push(m[2].newIndex),s.push(m[0].newIndex),s.push(m[2].newIndex),s.push(m[3].newIndex))}}return m.push(new Re),m.push(new Re),m.push(new Re),m.push(new Re),t(function(e,t){var i=e.isEastChild,n=e.isNorthChild,s=i?me:0,r=i?ge:me,h=n?me:0,u=n?ge:me,o=ye,a=be,p=Ie,d=Te;o.length=0,a.length=0,p.length=0,d.length=0;var f=Ae;f.length=0;for(var l={},c=e.vertices,g=(g=e.indices).subarray(0,e.indexCountWithoutSkirts),m=pe.TerrainEncoding.clone(e.encoding),x=m.hasVertexNormals,v=0,w=e.vertexCountWithoutSkirts,C=e.minimumHeight,B=e.maximumHeight,y=new Array(w),b=new Array(w),I=new Array(w),A=x?new Array(2*w):void 0,T=0,z=0;T<w;++T,z+=2){var M=m.decodeTextureCoordinates(c,T,Ve),N=m.decodeHeight(c,T),V=fe.CesiumMath.clamp(M.x*ge|0,0,ge),E=fe.CesiumMath.clamp(M.y*ge|0,0,ge);I[T]=fe.CesiumMath.clamp((N-C)/(B-C)*ge|0,0,ge),ge-(V=V<20?0:V)<20&&(V=ge),ge-(E=E<20?0:E)<20&&(E=ge),y[T]=V,b[T]=E,x&&(M=m.getOctEncodedNormal(c,T,Ee),A[z]=M.x,A[z+1]=M.y),(i&&me<=V||!i&&V<=me)&&(n&&me<=E||!n&&E<=me)&&(l[T]=v,o.push(V),a.push(E),p.push(I[T]),x&&(d.push(A[z]),d.push(A[z+1])),++v)}var R=[];R.push(new Re),R.push(new Re),R.push(new Re);var H=[];for(H.push(new Re),H.push(new Re),H.push(new Re),T=0;T<g.length;T+=3){var O=g[T],S=g[T+1],U=g[T+2],F=y[O],P=y[S],k=y[U];R[0].initializeIndexed(y,b,I,A,O),R[1].initializeIndexed(y,b,I,A,S),R[2].initializeIndexed(y,b,I,A,U);var D,k=ce.clipTriangleAtAxisAlignedThreshold(me,i,F,P,k,xe);k.length<=0||(D=H[0].initializeFromClipResult(k,0,R))>=k.length||(D=H[1].initializeFromClipResult(k,D,R))>=k.length||(D=H[2].initializeFromClipResult(k,D,R),He(o,a,p,d,f,l,ce.clipTriangleAtAxisAlignedThreshold(me,n,H[0].getV(),H[1].getV(),H[2].getV(),ve),H,x),D<k.length&&(H[2].clone(H[1]),H[2].initializeFromClipResult(k,D,R),He(o,a,p,d,f,l,ce.clipTriangleAtAxisAlignedThreshold(me,n,H[0].getV(),H[1].getV(),H[2].getV(),ve),H,x)))}var W=i?-ge:0,X=n?-ge:0,K=[],L=[],Y=[],_=[],G=Number.MAX_VALUE,J=-G,Z=we;Z.length=0;var j=ae.Ellipsoid.clone(e.ellipsoid),q=(ue=ae.Rectangle.clone(e.childRectangle)).north,Q=ue.south,$=ue.east,ee=ue.west;for($<ee&&($+=fe.CesiumMath.TWO_PI),T=0;T<o.length;++T)V=(V=Math.round(o[T]))<=s?(K.push(T),0):r<=V?(Y.push(T),ge):2*V+W,o[T]=V,E=(E=Math.round(a[T]))<=h?(L.push(T),0):u<=E?(_.push(T),ge):2*E+X,a[T]=E,(N=fe.CesiumMath.lerp(C,B,p[T]/ge))<G&&(G=N),J<N&&(J=N),p[T]=N,Ce.longitude=fe.CesiumMath.lerp(ee,$,V/ge),Ce.latitude=fe.CesiumMath.lerp(Q,q,E/ge),Ce.height=N,j.cartographicToCartesian(Ce,Be),Z.push(Be.x),Z.push(Be.y),Z.push(Be.z);var te=oe.BoundingSphere.fromVertices(Z,ae.Cartesian3.ZERO,3,Me),ie=le.OrientedBoundingBox.fromRectangle(ue,G,J,j,Ne),e=new pe.EllipsoidalOccluder(j).computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid(te.center,Z,3,te.center,G,ze),ne=J-G,se=new Uint16Array(o.length+a.length+p.length);for(T=0;T<o.length;++T)se[T]=o[T];var re=o.length;for(T=0;T<a.length;++T)se[re+T]=a[T];for(re+=a.length,T=0;T<p.length;++T)se[re+T]=ge*(p[T]-G)/ne;var he,ue=de.IndexDatatype.createTypedArray(o.length,f);return x?(he=new Uint8Array(d),t.push(se.buffer,ue.buffer,he.buffer),he=he.buffer):t.push(se.buffer,ue.buffer),{vertices:se.buffer,encodedNormals:he,indices:ue.buffer,minimumHeight:G,maximumHeight:J,westIndices:K,southIndices:L,eastIndices:Y,northIndices:_,boundingSphere:te,orientedBoundingBox:ie,horizonOcclusionPoint:e}})});
